<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>II Overlay HUD â€“ Compact (Ã©cart horizontal rÃ©duit)</title>
<style>
html,body{height:100%;margin:0;background:transparent}
#hud{position:fixed;bottom:10px;left:10px;z-index:1;max-width:min(92vw,640px);min-width:500px;
color:#fff;border:1px solid rgba(255,255,255,.18);border-radius:10px;
box-shadow:0 6px 18px rgba(0,0,0,.45);
font:600 12.5px/1.15 ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;
background:rgba(0,0,0,.56);backdrop-filter:blur(2.5px)}
.content{padding:10px 10px 9px;position:relative}

/* Bandeau round */
.roundBadge{position:absolute;top:-14px;right:14px;background:rgba(0,0,0,.85);
border:1px solid rgba(255,255,255,.25);padding:4px 8px;border-radius:999px;
font-weight:900;letter-spacing:.25px;font-size:10px;display:flex;align-items:center;gap:5px;
box-shadow:0 4px 9px rgba(0,0,0,.45)}
.dot{width:6px;height:6px;border-radius:50%;background:#ffd257;box-shadow:0 0 0 1px rgba(255,210,87,.28)}

/* Pastilles joueurs */
.playersTrack{display:flex;gap:3px;flex-wrap:wrap;align-items:center;margin:0 0 6px;padding:0 2px}
.pPill{display:inline-flex;align-items:center;gap:5px;border:1px solid rgba(255,255,255,.15);
background:rgba(255,255,255,.08);padding:2px 5px;border-radius:999px;font-weight:800;font-size:10px;
letter-spacing:.15px;opacity:.93;white-space:nowrap}
.pDot{width:6px;height:6px;border-radius:999px;background:#9ad7b0;box-shadow:0 0 0 1px rgba(0,0,0,.18) inset}
.pPill.crit{filter:saturate(1.2);animation:pulseCrit 1.2s ease-in-out infinite}
@keyframes pulseCrit{0%{box-shadow:0 0 0 0 rgba(255,66,66,0)}50%{box-shadow:0 0 0 3px rgba(255,66,66,.3)}100%{box-shadow:0 0 0 0 rgba(255,66,66,0)}}

/* Ligne compacte horizontale */
.rows{margin:0}
.row{position:relative;display:grid;
grid-template-columns:minmax(130px,1fr) minmax(150px,250px) max-content;
align-items:center;column-gap:1px;margin:3px 0;padding:3px 5px;border-radius:7px;
transition:transform .12s ease,box-shadow .12s ease,background .12s ease}

/* Couleur par camp */
.row.pc {border-left:3px solid rgba(0,255,180,.4);}
.row.npc{border-left:3px solid rgba(255,80,80,.35);}
.row.pc.current {background:rgba(0,255,180,.07);}
.row.npc.current{background:rgba(255,80,80,.07);}

.row.current{transform:scale(1.008);}
.name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:900;letter-spacing:.12px}
.name.deadName{opacity:.6;text-decoration:line-through}
.hpBar{height:7px;background:rgba(20,20,20,.72);border-radius:4px;overflow:hidden;
box-shadow:inset 0 0 0 1px rgba(255,255,255,.05);position:relative}
.hpFill{display:block;height:100%}
.hpTxt{min-width:48px;text-align:right;opacity:.95;font-size:11.5px}
.skull{min-width:16px;text-align:right;font-size:12px}
.dimmed{opacity:.55;filter:saturate(.85)}
.tags{display:flex;gap:3px;flex-wrap:wrap;margin-top:1px;grid-column:1 / -1}
.tag{font-weight:700;font-size:9px;letter-spacing:.15px;padding:1px 4px;border-radius:999px;
background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);white-space:nowrap}
.tag.poison{background:rgba(0,200,80,.2);border-color:rgba(0,200,80,.35)}
.tag.stun{background:rgba(255,90,90,.2);border-color:rgba(255,90,90,.35)}

/* .npcFull reserved for future styling if needed */
</style>
</head>
<body>
<div id="hud">
 <div class="content">
  <div class="roundBadge"><span class="dot"></span><span id="roundText">Round 1</span></div>
  <div class="playersTrack" id="playersTrack"></div>
  <div class="rows" id="rows"></div>
 </div>
</div>

<script>
(function(){
 const rowsEl=document.getElementById('rows');
 const pTrackEl=document.getElementById('playersTrack');
 const roundText=document.getElementById('roundText');
 const qs=new URLSearchParams(location.search);
 const WS_URL=qs.get('ws')||'ws://127.0.0.1:8091/hud';
 const SHOW_GM=qs.get('gm')==='1'; const SHOW_HIDDEN=qs.get('showHidden')==='1';
 const playersParam=(qs.get('players')||'').split(',').map(s=>s.trim()).filter(Boolean);
 const PC_SET=new Set(playersParam.length?playersParam:['Pierre','Loic','Gabriele','Joel','Ana\u00ebl','AnaÃ«l','Tristan','Maureen']);
 const ESC_MAP={'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}; const esc=s=>String(s).replace(/[&<>"']/g,m=>ESC_MAP[m]);
 const pctColor=p=>!isFinite(p)?'#42d07c':p<=5?'#4a155a':p<=20?'#a3082a':p<=40?'#ff5d5d':p<=60?'#ff9f43':p<=80?'#ffd257':'#42d07c';
 const isPlayer=c=>!!(c?.isPlayer||c?.player||['pc','ally'].includes(c?.role)||PC_SET.has(c?.name));
 const tagClass=t=>/(poison|empoison)/i.test(t)?'tag poison':/(stun|Ã©tourdi|assommÃ©)/i.test(t)?'tag stun':'tag';
 const sanitizeTags=tags=>tags.map(t=>typeof t==='string'?t:(t?.text||'')).filter(t=>t&&!/^(add|remove|ajouter|retirer)\b/i.test(t));

 let lastTurn=-1,roundCounter=1,lastRosterKey=null,lastEncounterId=null;

 const rosterKey=list=>Array.isArray(list)?list.map(c=>c?.id??c?.uuid??c?.name??'').join('|'):'';
 const resetRound=()=>{ roundCounter=1; lastTurn=-1; lastRosterKey=null; lastEncounterId=null; roundText.textContent=`Round ${roundCounter}`; };

 function updateRound(state){
  const provided = state?.round ?? state?.Round ?? state?.roundCounter ?? state?.RoundCounter;
  const turn = Number(state?.turn || 0);
  const list = Array.isArray(state?.list) ? state.list : [];
  const key  = rosterKey(list);
  const encounterId = state?.encounterId ?? state?.EncounterId ?? state?.encounter?.id ?? null;
  const encounterInactive = state?.encounterActive === false || state?.isActive === false || state?.state === 'inactive' || state?.status === 'inactive';

  if (encounterInactive){
    resetRound();
    return;
  }

  if (encounterId && encounterId !== lastEncounterId){
    lastEncounterId = encounterId;
    roundCounter = (typeof provided==='number' && provided>=1) ? provided : 1;
    lastTurn = turn;
    lastRosterKey = key || null;
    roundText.textContent = `Round ${roundCounter}`;
    return;
  }

  if (list.length === 0){
    resetRound();
    return;
  }

  if (lastRosterKey && key !== lastRosterKey){
    roundCounter = (typeof provided==='number' && provided>=1) ? provided : 1;
    lastTurn = -1;
  }
  lastRosterKey = key;

  if (typeof provided === 'number' && provided >= 1){
    roundCounter = provided;
    lastTurn = turn; // trust explicit round, align turn baseline
  } else if (lastTurn >= 0 && turn < lastTurn){
    roundCounter += 1;
    lastTurn = turn;
  } else {
    lastTurn = turn;
  }

  roundText.textContent = `Round ${roundCounter}`;
 }

 function renderPlayers(list){
  const pcs=list.filter(c=>isPlayer(c)&&(!(c?.hidden||c?.isHidden)||SHOW_HIDDEN));
  pTrackEl.innerHTML=pcs.map(c=>{
   const n=esc(c?.name??'?');
   const cur=+c?.cur,max=+c?.max,pct=isFinite(cur)&&isFinite(max)&&max>0?Math.max(0,Math.min(100,Math.round(cur*100/max))):NaN;
   const clr=pctColor(pct),crit=pct<=10,cls=crit?'pPill crit':'pPill';
   return `<span class="${cls}" title="${n} ${cur}/${max}">
     <span class="pDot" style="background:${clr}"></span>
     <span>${n}</span>
     <span>Â·</span>
     <span>${cur}/${max}</span>
   </span>`;
  }).join('');
 }

 function render(s){
  updateRound(s);
  const list=Array.isArray(s?.list)?s.list:[],turn=+s?.turn||0;
  const ord=turn>0?list.slice(turn).concat(list.slice(0,turn)):list;
  const curRef=ord[0]&&(ord[0].id??ord[0].uuid??ord[0].name);
  renderPlayers(list);
  const rows=ord.filter(c=>!(c?.isHidden||c?.hidden)||SHOW_HIDDEN).map(c=>{
   const name=esc(c?.name??'?'),cur=+c?.cur,max=+c?.max,pct=isFinite(cur)&&isFinite(max)&&max>0?Math.max(0,Math.min(100,Math.round(cur*100/max))):NaN;
   const clr=pctColor(pct),isPC=isPlayer(c),isCur=(c?.id??c?.uuid??c?.name)===curRef;
   const nameCls=(cur<=0)?'name deadName':'name';
   const tags=sanitizeTags(c?.tags||[]);
   const barWidth = isPC ? `${pct}%` : `100%`;
const isDead = cur <= 0;
const bar = isDead ? `` : `<div class="hpBar"><span class="hpFill${isPC?"":" npcFull"}" style="width:${barWidth};background:${clr}"></span></div>`;
   return `<div class="row ${isPC?'pc':'npc'}${isCur?' current':''}">
    <div class="${nameCls}">${name}</div>
    ${bar}<div class="hpTxt">${isPC?' ':' '}</div>
    ${cur<=0?'<div class="skull"></div>':'<div class="skull"></div>'}
    ${tags.length?`<div class="tags">${tags.map(t=>`<span class="${tagClass(t)}">${esc(t)}</span>`).join('')}</div>`:''}
   </div>`;
  });
  rowsEl.innerHTML=rows.join('')||'<div class="name" style="opacity:.8;padding:4px 8px">En attenteâ€¦</div>';
 }

 const norm=ev=>ev.data instanceof Blob?ev.data.text():Promise.resolve(typeof ev.data==='string'?ev.data:JSON.stringify(ev.data));
 const handle=txt=>{let m;try{m=JSON.parse(txt);}catch{return;}
  const s=(m?.type==='ii_state'&&m.data)?m.data:(m?.list?m:(m?.data?.list?m.data:null));if(s)render(s);}
 function connect(){const ws=new WebSocket(WS_URL);
  ws.onopen=()=>console.log('[overlay-compact] open');ws.onclose=()=>setTimeout(connect,1e3);
  ws.onmessage=e=>norm(e).then(handle);}
 connect();
})();
</script>
</body>
</html>




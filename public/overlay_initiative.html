<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>II Overlay - Initiative simple</title>
<style>
html,body{height:100%;margin:0;background:transparent}
body{font:600 14px/1.2 ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;color:#0d1824}
#wrap{
  position:fixed;bottom:12px;left:12px;z-index:10;
  width:min(820px,92vw);background:rgba(255,255,255,.96);
  border:1px solid rgba(0,0,0,.08);border-radius:12px;overflow:hidden;
  box-shadow:0 10px 26px rgba(0,0,0,.28);
}
.header{
  display:grid;grid-template-columns:70px 1fr 140px;
  align-items:center;padding:10px 14px;background:#0f1c26;color:#f7fbff;
  font-weight:800;letter-spacing:.3px;font-size:13px;
}
.rows{display:flex;flex-direction:column;}
.row{
  display:grid;grid-template-columns:70px 1fr 140px;
  align-items:center;padding:10px 14px;gap:10px;
  background:#f4f4f0;
}
.row:nth-child(2n){background:#e9e6de;}
.row.current{box-shadow:inset 0 0 0 2px #4da3ff;background:#eef5ff;}
.init{font-weight:900;opacity:.8;text-align:right;}
.nameWrap{display:flex;align-items:center;gap:10px;min-width:0;}
.portrait{
  width:32px;height:32px;border-radius:6px;object-fit:cover;border:1px solid rgba(0,0,0,.08);
  background:#dfe3e8;
}
.name{font-weight:800;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.hp{font-weight:800;color:#176b34;}
.hp.enemy{color:#6b7280;}
.empty{opacity:.6;font-weight:700;}
</style>
</head>
<body>
  <div id="wrap">
    <div class="header">
      <div>Init</div><div>Nom</div><div>PV</div>
    </div>
    <div class="rows" id="rows">
      <div class="row"><div class="empty" style="grid-column:1 / -1">En attente…</div></div>
    </div>
  </div>

<script>
(function(){
  const rowsEl = document.getElementById('rows');
  const qs = new URLSearchParams(location.search);
  const WS_URL = qs.get('ws') || 'ws://127.0.0.1:8091/hud';
  const playersParam = (qs.get('players') || '').split(',').map(s=>s.trim()).filter(Boolean);
  const PC_SET = new Set(playersParam.length ? playersParam : ['Pierre','Loic','Gabriele','Joel','Anaël','AnaǮl','Tristan','Maureen']);

  const ESC = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"};
  const esc = s => String(s).replace(/[&<>"']/g, m => ESC[m]);

  const isPlayer = c => {
    if (!c || typeof c !== 'object') return false;
    if (c.isPlayer === true || c.player === true) return true;
    if (['pc','ally'].includes(c.role)) return true;
    if (typeof c.PersistentCharacterId === 'string' || typeof c.persistentCharacterId === 'string') return true;
    if (typeof c.Player === 'string' && c.Player.toLowerCase() === 'player') return true;
    return PC_SET.has(c.name);
  };

  const pctColor = pct => {
    if (!isFinite(pct)) return '#176b34';
    if (pct <= 25) return '#b91c1c';
    if (pct <= 50) return '#d97706';
    return '#176b34';
  };

  function render(state){
    const turn = Number(state?.turn || 0);
    const list = Array.isArray(state?.list) ? state.list : [];
    if (!list.length){
      rowsEl.innerHTML = '<div class="row"><div class="empty" style="grid-column:1 / -1">Aucun combattant…</div></div>';
      return;
    }
    const ordered = turn>0 ? list.slice(turn).concat(list.slice(0,turn)) : list;
    const curRef = ordered[0] && (ordered[0].id ?? ordered[0].uuid ?? ordered[0].name);

    rowsEl.innerHTML = ordered.map(c => {
      const name = esc(c?.name ?? '?');
      const init = c?.init ?? c?.initiative ?? c?.Initiative ?? 0;
      const hpCur = Number(c?.cur);
      const hpMax = Number(c?.max);
      const hasHP = isFinite(hpCur) && isFinite(hpMax) && hpMax > 0;
      const hpPct = hasHP ? Math.max(0, Math.min(100, Math.round(hpCur * 100 / hpMax))) : NaN;
      const ac = c?.ac ?? c?.AC ?? c?.armorClass ?? '';
      const portrait = c?.img || c?.image || c?.imageUrl || c?.ImageURL || '';
      const isPC = isPlayer(c);
      const isCur = (c?.id ?? c?.uuid ?? c?.name) === curRef;

      const hpCell = isPC && hasHP
        ? `<span class="hp" style="color:${pctColor(hpPct)}">${hpCur}/${hpMax}</span>`
        : `<span class="hp enemy">–</span>`;

      const portraitHtml = portrait ? `<img class="portrait" src="${esc(portrait)}" alt="">`
                                    : `<div class="portrait"></div>`;

      return `<div class="row${isCur ? ' current' : ''}">
        <div class="init">${init}</div>
        <div class="nameWrap">${portraitHtml}<div class="name">${name}</div></div>
        <div>${hpCell}</div>
      </div>`;
    }).join('');
  }

  function norm(ev){
    if (typeof ev.data === 'string') return Promise.resolve(ev.data);
    if (ev.data instanceof Blob) return ev.data.text();
    if (ev.data instanceof ArrayBuffer) return Promise.resolve(new TextDecoder().decode(ev.data));
    try { return Promise.resolve(JSON.stringify(ev.data)); } catch { return Promise.resolve(''); }
  }

  function handle(txt){
    let msg; try{ msg = JSON.parse(txt); }catch{ return; }
    const state = (msg?.type === 'ii_state' && msg.data) ? msg.data
                : (msg?.list && msg?.turn != null) ? msg
                : (msg?.data?.data?.list ? msg.data.data
                   : (msg?.data?.list ? msg.data : null));
    if (state) render(state);
  }

  function connect(){
    const ws = new WebSocket(WS_URL);
    ws.onopen = () => console.log('[overlay-initiative] open');
    ws.onclose = () => setTimeout(connect, 1000);
    ws.onerror = () => {};
    ws.onmessage = ev => norm(ev).then(handle).catch(()=>{});
  }
  connect();
})();
</script>
</body>
</html>
